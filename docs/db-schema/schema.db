CREATE TABLE Store (
    StoreId BIGSERIAL PRIMARY KEY,
    StoreName VARCHAR(120) NOT NULL,
    StoreAddress TEXT NOT NULL,
    StoreEmail VARCHAR(255) NOT NULL UNIQUE,
    StorePhone VARCHAR(40),
    Description TEXT,
    Logo TEXT,
    OwnerName VARCHAR(120) NOT NULL,
    OwnerEmail VARCHAR(255) NOT NULL,
    OwnerAddress TEXT,
    OwnerPhone VARCHAR(40),
    DateCreated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    LastUpdate TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Product (
    ProductId BIGSERIAL PRIMARY KEY,
    StoreId BIGINT NOT NULL REFERENCES Store(StoreId) ON DELETE CASCADE,
    Name VARCHAR(120) NOT NULL,
    Price NUMERIC(12,2) NOT NULL CHECK (Price >= 0),
    DateCreated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    LastUpdate TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Buyer (
    BuyerId BIGSERIAL PRIMARY KEY,
    BuyerName VARCHAR(120) NOT NULL,
    BuyerEmail VARCHAR(255) NOT NULL UNIQUE,
    BuyerAddress TEXT,
    BuyerPhone VARCHAR(40)
);

CREATE TABLE CartItem (
    CartItemId BIGSERIAL PRIMARY KEY,
    BuyerId BIGINT NOT NULL REFERENCES Buyer(BuyerId) ON DELETE CASCADE,
    ProductId BIGINT NOT NULL REFERENCES Product(ProductId) ON DELETE CASCADE,
    Quantity INTEGER NOT NULL CHECK (Quantity > 0),
    UNIQUE (BuyerId, ProductId)
);

CREATE TABLE Order (
    OrderId BIGSERIAL PRIMARY KEY,
    BuyerId BIGINT NOT NULL REFERENCES Buyer(BuyerId) ON DELETE CASCADE,
    Status OrderStatus NOT NULL DEFAULT 'PENDING',
    DateCreated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE OrderLine (
    OrderLineId BIGSERIAL PRIMARY KEY,
    OrderId BIGINT NOT NULL REFERENCES Order(OrderId) ON DELETE CASCADE,
    ProductId BIGINT NOT NULL REFERENCES Product(ProductId) ON DELETE CASCADE,
    Quantity INTEGER NOT NULL CHECK (Quantity > 0),
    Price NUMERIC(12,2) NOT NULL CHECK (Price >= 0)
);

CREATE TABLE StoreReview (
    ReviewId BIGSERIAL PRIMARY KEY,
    StoreId BIGINT NOT NULL REFERENCES Store(StoreId) ON DELETE CASCADE,
    BuyerId BIGINT NOT NULL REFERENCES Buyer(BuyerId) ON DELETE CASCADE,
    Rating SMALLINT NOT NULL CHECK (Rating BETWEEN 1 AND 5),
    Comment TEXT,
    DateCreated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (StoreId, BuyerId)
);

CREATE TABLE ProductReview (
    ReviewId BIGSERIAL PRIMARY KEY,
    ProductId BIGINT NOT NULL REFERENCES Product(ProductId) ON DELETE CASCADE,
    BuyerId BIGINT NOT NULL REFERENCES Buyer(BuyerId) ON DELETE CASCADE,
    Rating SMALLINT NOT NULL CHECK (Rating BETWEEN 1 AND 5),
    Comment TEXT,
    DateCreated TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (ProductId, BuyerId)
);